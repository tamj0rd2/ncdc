version: "3.7"
services:
  lint:
    build:
      context: .
      target: setup
    command: npm run lint
    volumes:
      - ./:/usr/src/app

  typecheck:
    build:
      context: .
      target: setup
    command: npm run typecheck
    volumes:
      - ./:/usr/src/app

  # coverage upload only works in CI
  cover:
    build:
      context: .
      target: setup
    command: bash -c 'npm run cover && bash <(curl -s https://codecov.io/bash)'
    volumes:
      - ./:/usr/src/app

  release:
    build:
      context: .
      target: setup
    environment:
      - GITHUB_TOKEN
      - NPM_TOKEN
    command: npx semantic-release
    volumes:
      - ./:/usr/src/app

  post-deploy:
    build:
      context: .
      target: post_deploy
    command: npx jest --runInBand --bail --detectOpenHandles
    environment:
      - TEST_MODE=acceptance
      - NCDC_EXEC=./node_modules/.bin/ncdc
